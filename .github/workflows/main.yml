name: Remote MacOS Access

on:
  push:
  workflow_dispatch:

jobs:
  remote-access:
    runs-on: macos-latest
    env:
      # Убедитесь, что путь к Homebrew добавлен в PATH
      PATH: /opt/homebrew/bin:/opt/homebrew/sbin:${{ env.PATH }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    # Шаг установки ngrok, используя предустановленный Homebrew
    - name: Install ngrok
      run: brew install --cask ngrok

    # Шаг настройки VNC для macOS
    - name: Configure VNC
      run: |
        # Включить удалённый доступ к экрану (VNC)
        sudo /System/Library/CoreServices/Menu\ Extras/User.menu/Contents/Resources/CGSession -suspend
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -access -on -restart -agent -privs -all
        
        # Настройка пароля для VNC из GitHub Secrets
        VNC_PASSWORD="${{ secrets.VNC_PASSWORD }}"
        # Кодирование пароля с использованием openssl
        ENCODED_PASSWORD=$(echo -n "$VNC_PASSWORD" | /usr/bin/openssl enc -aes-128-cbc -a -salt -pass pass:"ngrok")
        sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCPassword -string "$ENCODED_PASSWORD"

    # Шаг запуска туннеля ngrok
    - name: Start ngrok Tunnel
      run: |
        # Запуск ngrok в фоновом режиме для порта VNC (5900)
        ngrok tcp 5900 --log=stdout > ngrok.log &
        # Ожидание запуска туннеля
        sleep 15
        # Получение публичного URL от ngrok
        ngrok_url=$(grep -o "tcp://[0-9\.]*:[0-9]*" ngrok.log | head -n1)
        echo "NGROK_URL=${ngrok_url}" >> $GITHUB_ENV

    # Шаг вывода информации для подключения
    - name: Output Connection Info
      run: |
        echo "✅ Подключитесь к VNC по адресу: ${{ env.NGROK_URL }}"
